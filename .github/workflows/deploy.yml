name: Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest

    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      LOCAL_VERSION_NUMBER_FILE: build_version.txt

    steps:
      - name: Check out the repository 
        uses: actions/checkout@v2.3.4
        with:
          ref: main

      - name: Determine the projectâ€™s version
        id: version
        uses: anttikivi/maintain-revision@v0.10.1
        with:
          type: npm
          download: false
          upload: false

      - name: Install dependencies
        run: yarn install

      - name: Build
        run: yarn build

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3.7.3
        with:
          deploy_key: ${{ secrets.ACTIONS_DEPLOY_KEY }}
          publish_branch: main
          allow_empty_commit: true
          external_repository: visiosto/visiosto.github.io
          commit_message: "chore: deploy v${{ steps.version.outputs.version }} of the site"
